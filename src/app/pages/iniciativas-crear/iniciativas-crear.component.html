<app-navbar></app-navbar>
<div class="container mt-4 animate__animated animate__fadeIn animate__faster">
    <h5 class="px-4 py-2 mb-4 text-white display-block bg-secondary d-flex justify-content-between align-items-center">
        <strong *ngIf="this.iniciativa_id">Actualizar Iniciativa</strong>
        <strong *ngIf="!this.iniciativa_id">Crear Iniciativa</strong>
        <a [routerLink]="['/iniciativas']" class="btn btn-light border-white btn-sm" role="button">Volver</a>
    </h5>

    <div class="row">

        <div class="col-12">

            <div class="card">

                <form
                    (ngSubmit)="enviarIniciativa()"
                    *ngIf="crearIniciativaForm"
                    [formGroup]="crearIniciativaForm"
                    autocomplete="off"
                    id="form-iniciativa"
                    role="form">

                    <div class="card-body">

                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label>Título</label>
                                    <input autocapitalize="none" autocorrect="off" class="form-control" formControlName="titulo" id="titulo" name="titulo" placeholder="Título corto y descriptivo" spellcheck="false" type="text">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="descripcion">Descripción</label>
                                    <textarea class="form-control" formControlName="descripcion" id="descripcion" name="descripcion" placeholder="Escribe una descripción detallada y larga sobre la iniciativa" rows="8"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="ciudad">Localización de desarrollo de la iniciativa</label>
                                    <select class="form-control" formControlName="ciudad" id="ciudad" name="ciudad">
                                        <option value="">Elije una ciudad de desarrollo de la iniciativa</option>
                                        <option *ngFor="let CIUDAD of CIUDADES" [selected]="this.iniciativa.ciudad == CIUDAD" value="{{ CIUDAD }}">{{ CIUDAD }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="rama">Rama de Conocimiento</label>
                                    <select class="form-control" formControlName="rama" id="rama" name="area">
                                        <option value="">Elije una rama de conocimiento</option>
                                        <option *ngFor="let RAMA of RAMAS" [selected]="this.iniciativa.rama == RAMA" value="{{ RAMA }}">{{ RAMA }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="this.iniciativa_id" class="row">
                            <div class="col-6 justify-content-between">
                                <div class="border p-3 w-100 mb-3">
                                    <div class="form-group">
                                        <label for="ficheros">Ficheros</label>

                                        <div class="form-group">
                                            <label class="custom-file-upload" for="file-upload-2">
                                                <em class="fa fa-cloud-upload"></em> Subir Fichero (solo pdf)
                                            </label>
                                            <input (change)="subirFichero($event.target.files[0])" id="file-upload-2" type="file"/>
                                        </div>

                                    </div>

                                    <p *ngIf="iniciativa.archivos.length === 0">No se ha subido ningún archivo para esta iniciativa</p>

                                    <ul *ngIf="iniciativa.archivos.length > 0" class="list-group">
                                        <li *ngFor="let archivo of iniciativa.archivos" class="list-group-item">
                                            <a href="{{ archivo.url }}" target="_blank">{{ archivo.client_name }}</a>
                                            <span (click)="borrarFichero(archivo._id)" aria-label="Borrar Fichero" class="float-right cursor-pointer text-danger"><fa-icon [icon]="['fas', 'trash']"></fa-icon></span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-6 justify-content-between">

                                <div class="border p-3 w-100 mb-3">

                                    <div class="d-flex justify-content-between">
                                        <label>Imagen de iniciativa {{ iniciativa.imagen === '' ? ' (actualmente por defecto)' : '' }}</label>
                                        <span (click)="borrarImagen()" *ngIf="!this.imagenPreview && iniciativa.imagen != ''" aria-label="Borrar Imagen" class="remove-image-btn">borrar actual</span>
                                    </div>

                                    <div class="row">

                                        <div class="col-6">
                                            <img *ngIf="this.imagenPreview" [src]="this.imagenPreview" alt="preview" class="img-fluid"/>
                                            <img *ngIf="!this.imagenPreview" [src]="iniciativa.imagenUrl" alt="preview" class="img-fluid"/>
                                        </div>

                                        <div class="col-6 d-flex flex-column justify-content-between">

                                            <div class="form-group">
                                                <label class="custom-file-upload" for="file-upload">
                                                    <em class="fa fa-cloud-upload"></em> Subir imagen
                                                </label>
                                                <input (change)="cambiarImagen($event.target.files[0])" id="file-upload" type="file"/>
                                            </div>

                                            <button (click)="actualizarImagen()" [disabled]="!imagenSubir" class="btn btn-secondary btn-sm" type="button">Actualizar Imagen</button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div *ngIf="this.usuarioService.usuario.esGestor && USUARIOS" class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="proponedor">Proponedor (solo modificable por el gestor del portal)</label>
                                    <select class="form-control" formControlName="proponedor" id="proponedor" name="area">
                                        <option value="">Elije un usuario que se haga cargo de la iniciativa</option>
                                        <option *ngFor="let USUARIO of USUARIOS" [selected]="this.iniciativa.proponedor == USUARIO.uid" value="{{ USUARIO.uid }}">{{ USUARIO.email }} - {{ USUARIO.displayRol }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div *ngIf="!this.iniciativa_id" class="card text-white bg-info mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title text-center">
                                            <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                                            Info
                                        </h5>
                                        <p class="card-text">Una vez creados los datos básicos de la iniciativa, se podrán subir archivos e imágenes a la misma, así como editar sus datos básicos.</p>
                                    </div>
                                </div>
                            </div>

                            <div *ngIf="!this.iniciativa_id" class="col">
                                <div class="form-check text-right m-4">
                                    <input class="form-check-input" formControlName="terminos_aceptados" id="terminos_aceptados" type="checkbox">
                                    <label class="form-check-label">Entiendo <a [routerLink]="['/que-es-ApS']" href="javascript:void(0)" target="_blank">Qué es un Proyecto ApS</a></label>
                                </div>

                            </div>
                        </div>


                        <div class="d-flex">
                            <div *ngIf="this.crearIniciativaForm.invalid && this.formSubmitted" class="flex-fill alert alert-danger mr-3" role="alert">
                                <div *ngIf="campoNoValido('estado')" class="col">{{ campoNoValido('estado') }}</div>
                                <div *ngIf="campoNoValido('titulo')" class="col">{{ campoNoValido('titulo') }}</div>
                                <div *ngIf="campoNoValido('descripcion')" class="col">{{ campoNoValido('descripcion') }}</div>
                                <div *ngIf="campoNoValido('rama')" class="col">{{ campoNoValido('rama') }}</div>
                                <div *ngIf="campoNoValido('ciudad')" class="col">{{ campoNoValido('ciudad') }}</div>
                                <div *ngIf="campoNoValido('proponedor')" class="col">{{ campoNoValido('proponedor') }}</div>
                                <div *ngIf="campoNoValido('terminos_aceptados')" class="col">{{ campoNoValido('terminos_aceptados') }}</div>
                            </div>

                            <div class="ml-auto mb-2">
                                <input *ngIf="!this.iniciativa_id" [disabled]="this.formSending || (this.formSubmitted && this.crearIniciativaForm.invalid)" [value]="this.formSending ? 'Creando...' : 'Crear Iniciativa'" class="btn btn-default btn-secondary m-4" type="submit">
                                <input *ngIf="this.iniciativa_id" [disabled]="this.formSending || (this.formSubmitted && this.crearIniciativaForm.invalid)" [value]="this.formSending ? 'Actualizando...' : 'Actualizar Iniciativa'" class="btn btn-default btn-secondary m-4" type="submit">
                            </div>
                        </div>


                    </div>
                </form>

            </div>
        </div>
    </div>

</div>
<app-footer></app-footer>
